<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Smart Farm Dashboard</title>
<style>
body { font-family: 'Segoe UI', sans-serif; margin:0; background:#f4f7fa; color:#333; }
.main-container { display:flex; height:100vh; }
.top-bar { position:fixed; top:0; width:100%; height:60px; background:#fff; border-bottom:1px solid #e0e0e0; display:flex; align-items:center; padding:0 24px; z-index:1000; }
.top-bar h1 { font-size:1.4em; color:#1a73e8; margin:0; }
.side-bar { width:240px; background:#fff; border-right:1px solid #e0e0e0; padding-top:80px; display:flex; flex-direction:column; justify-content:space-between; }
.side-bar ul { list-style:none; padding:0; margin:0; }
.side-bar li { padding:12px 20px; cursor:pointer; border-left:4px solid transparent; transition:0.2s; }
.side-bar li.active { background:#e8f0fe; border-left-color:#1967d2; font-weight:600; color:#1967d2; }
#delete-garden-btn { margin:20px; padding:12px; width:calc(100%-40px); border:none; border-radius:8px; background:#d9534f; color:#fff; cursor:pointer; transition:0.2s; }
#delete-garden-btn:disabled { background:#ccc; cursor:not-allowed; }
.content-area { flex-grow:1; display:flex; flex-direction:column; padding:80px 20px 20px 20px; gap:20px; overflow:hidden; }
#map-container { flex-basis:70%; border-radius:12px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
#map { width:100%; height:100%; }
#grid-container { flex-basis:30%; background:#fff; padding:20px; overflow-y:auto; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
#grid-container h3 { margin-top:0; margin-bottom:10px; font-size:1.1em; color:#3c4043; display:flex; align-items:center; gap:10px; }
.data-grid { display:grid; grid-template-columns:repeat(10,1fr); gap:6px; }
.grid-cell { width:100%; padding-bottom:100%; background:#eceff1; border-radius:4px; position:relative; transition:0.3s; }
.grid-cell span { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:rgba(0,0,0,0.4); font-size:0.75em; }
</style>
</head>
<body>
<div class="top-bar"><h1>Smart Farm Dashboard</h1></div>
<div class="main-container">
    <nav class="side-bar">
        <div>
            <h2>สวนทั้งหมด</h2>
            <ul id="garden-list"></ul>
        </div>
        <button id="delete-garden-btn" disabled>ลบสวนที่เลือก</button>
    </nav>
    <main class="content-area">
        <div id="map-container"><div id="map"></div></div>
        <div id="grid-container">
            <h3 id="grid-title">ข้อมูลค่าสี สวนที่ <span id="active-garden-label"></span>
            </h3>
            <div class="data-grid" id="data-grid"></div>
        </div>
    </main>
</div>

<script>
let map, activeGardenId=null, polygons={}, gardensData=[];
const deleteBtn=document.getElementById('delete-garden-btn');
const activeGardenLabel = document.getElementById('active-garden-label');

deleteBtn.onclick = ()=>{ if(activeGardenId) deleteGarden(activeGardenId); };

async function loadGridColors(gardenId){
    try{
        const res = await fetch(`/api/get_garden_colors/${gardenId}`);
        const colors = await res.json();
        const grid=document.getElementById('data-grid');

        // reset grid
        for(let i=0;i<100;i++){
            const cell=document.getElementById(`g${gardenId}-cell-${i}`);
            if(cell){ cell.style.backgroundColor='#eceff1'; cell.querySelector('span').style.display='block'; }
        }

        // add color & marker
        colors.forEach(c=>{
            const cell=document.getElementById(`g${gardenId}-cell-${c.cell_index}`);
            if(cell){ cell.style.backgroundColor=`rgb(${c.r},${c.g},${c.b})`; cell.querySelector('span').style.display='none'; }

            // marker
            if(map && c.lat!=null && c.lng!=null){
                const marker=new google.maps.Marker({
                    position:{lat:c.lat,lng:c.lng},
                    map:map,
                    icon:{ path:google.maps.SymbolPath.CIRCLE, scale:5, fillColor:`rgb(${c.r},${c.g},${c.b})`, fillOpacity:1, strokeWeight:0 }
                });
                if(!polygons[gardenId].colorMarkers) polygons[gardenId].colorMarkers=[];
                polygons[gardenId].colorMarkers.push(marker);
            }
        });
    }catch(e){ console.error('ไม่สามารถโหลดค่าสี:',e); }
}

function addGardenToSidebar(garden){
    const list=document.getElementById('garden-list');
    if(document.getElementById(`garden-item-${garden.garden_id}`)) return;
    const li=document.createElement('li');
    li.id=`garden-item-${garden.garden_id}`;
    li.innerText=`สวนที่ ${garden.garden_id}`;
    li.onclick=()=>setActiveGarden(garden.garden_id);
    list.appendChild(li);
}

function createGridCells(){
    const grid=document.getElementById('data-grid');
    grid.innerHTML='';
    if(!activeGardenId) return;
    const garden=gardensData.find(g=>g.garden_id==activeGardenId);
    if(!garden) return;
    for(let i=0;i<100;i++){
        const cell=document.createElement('div');
        cell.className='grid-cell';
        cell.id=`g${activeGardenId}-cell-${i}`;
        const span=document.createElement('span'); span.innerText=i+1; cell.appendChild(span);

        if(garden.grid && garden.grid[i]){
            const {r,g,b}=garden.grid[i];
            if(r||g||b){ cell.style.backgroundColor=`rgb(${r},${g},${b})`; span.style.display='none'; }
        }
        grid.appendChild(cell);
    }
}

function createPolygon(garden){
    const id=garden.garden_id;
    if(polygons[id]) { polygons[id].polygon.setMap(null); polygons[id].label.setMap(null); }
    const color='#2196F3';
    const polygon=new google.maps.Polygon({ paths:garden.coords, strokeColor:color, strokeOpacity:0.9, strokeWeight:2, fillColor:color, fillOpacity:0.35, map:map });
    const label=new google.maps.Marker({ position:getCenterOfPolygon(polygon), map:map, label:{text:`สวน ${id}`, color:"white", fontSize:"14px", fontWeight:"bold"}, icon:{path:google.maps.SymbolPath.CIRCLE, scale:0} });
    polygons[id]={polygon,label};
}

function getCenterOfPolygon(polygon){
    const bounds=new google.maps.LatLngBounds();
    polygon.getPath().getArray().forEach(v=>bounds.extend(v));
    return bounds.getCenter();
}

async function fetchAllGardens(){
    try{
        const res=await fetch('/api/get_all_gardens');
        const gardens=await res.json();
        gardensData=gardens;
        gardens.forEach(g=>{ addGardenToSidebar(g); createPolygon(g); });
        if(gardens.length>0 && !activeGardenId) setActiveGarden(gardens[0].garden_id);
    }catch(e){ console.error(e); }
}

async function deleteGarden(gardenId){
    if(!confirm(`คุณแน่ใจที่จะลบ "สวนที่ ${gardenId}"?`)) return;
    try{
        const res=await fetch(`/api/delete_garden/${gardenId}`,{method:'DELETE'});
        if(!res.ok) alert('เกิดข้อผิดพลาดในการลบสวน');
    }catch(e){ console.error(e);}
}

function connectWebSocket(){
    const ws=new WebSocket(`ws://${window.location.host}`);
    ws.onopen=()=>console.log('[WebSocket] เชื่อมต่อเซิร์ฟเวอร์สำเร็จ');
    ws.onmessage=(event)=>{
        const message=JSON.parse(event.data);
        switch(message.type){
            case'new_garden_added': addGardenToSidebar(message.data); createPolygon(message.data); if(!activeGardenId) setActiveGarden(message.data.garden_id); break;
            case'garden_deleted': removeGardenFromUI(message.data.garden_id); break;
            case'update_grid_cell':
                const {garden_id,cell_index,color}=message.data;
                const cell=document.getElementById(`g${garden_id}-cell-${cell_index}`);
                if(cell){ cell.style.backgroundColor=`rgb(${color.r},${color.g},${color.b})`; cell.querySelector('span').style.display='none'; }
                const gData=gardensData.find(g=>g.garden_id==garden_id);
                if(gData) gData.grid[cell_index]=color;
                break;
        }
    };
    ws.onclose=()=>setTimeout(connectWebSocket,3000);
}

function removeGardenFromUI(gardenId){
    document.getElementById(`garden-item-${gardenId}`)?.remove();
    if(polygons[gardenId]) { polygons[gardenId].polygon.setMap(null); polygons[gardenId].label.setMap(null); delete polygons[gardenId]; }
    if(activeGardenId==gardenId){ activeGardenId=null; document.getElementById('grid-title').innerText='กรุณาเลือกสวน'; document.getElementById('data-grid').innerHTML=''; deleteBtn.disabled=true; }
}

function setActiveGarden(gardenId){
    if(activeGardenId) document.getElementById(`garden-item-${activeGardenId}`)?.classList.remove('active');
    document.getElementById(`garden-item-${gardenId}`)?.classList.add('active');
    activeGardenId=gardenId;
    activeGardenLabel.innerText=gardenId;
    deleteBtn.disabled=false;
    createGridCells();

    // โหลดสีจาก DB
    loadGridColors(gardenId);

    // ลบ marker สีเก่าของสวนนี้
    if(polygons[gardenId]?.colorMarkers){
        polygons[gardenId].colorMarkers.forEach(m=>m.setMap(null));
        polygons[gardenId].colorMarkers=[];
    }
}

async function initMap(){
    map=new google.maps.Map(document.getElementById('map'),{ center:{lat:14.039,lng:100.613}, zoom:16, mapTypeId:'satellite' });
    await fetchAllGardens();
    connectWebSocket();
}
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAnohODDdNYfmogkNb-LUPPFNn79ZwP-YQ&callback=initMap"></script>
</body>
</html>
