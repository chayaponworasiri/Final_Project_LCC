<!-- File: index.html (‡∏â‡∏ö‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç - ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤) -->
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Smart Farm Dashboard</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background-color: #f4f7fa; color: #333; overflow: hidden; }
        .main-container { display: flex; height: 100vh; }
        .top-bar { position: fixed; top: 0; left: 0; width: 100%; height: 60px; background-color: #ffffff; border-bottom: 1px solid #e0e0e0; display: flex; align-items: center; padding: 0 24px; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .top-bar h1 { font-size: 1.4em; margin: 0; color: #1a73e8; }
        .side-bar { width: 240px; background-color: #ffffff; border-right: 1px solid #e0e0e0; padding-top: 80px; box-shadow: 2px 0 5px rgba(0,0,0,0.05); flex-shrink: 0; z-index: 900; }
        .side-bar h2 { padding: 0 24px; font-size: 1.0em; color: #5f6368; text-transform: uppercase; letter-spacing: 0.5px; }
        .side-bar ul { list-style-type: none; padding: 0; margin: 0; }
        .side-bar li { display: flex; justify-content: space-between; align-items: center; padding: 15px 24px; cursor: pointer; border-left: 4px solid transparent; transition: all 0.2s ease-in-out; }
        .side-bar li:hover { background-color: #f1f3f4; }
        .side-bar li.active { background-color: #e8f0fe; border-left-color: #1967d2; font-weight: 600; color: #1967d2; }
        
        /* === ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç === */
        .delete-btn {
            font-size: 1.2em;
            color: #888;
            padding: 5px;
            border-radius: 50%;
            /* display: none; ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤ */
        }
        .delete-btn:hover {
            background-color: #e0e0e0;
            color: #d32f2f;
        }
        /* === ‡∏à‡∏ö‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç === */
        
        .content-area { flex-grow: 1; display: flex; flex-direction: column; padding: 80px 20px 20px 20px; gap: 20px; overflow: hidden; }
        #map-container { flex-basis: 70%; width: 100%; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        #map { height: 100%; width: 100%; }
        #grid-container { flex-basis: 30%; background-color: #ffffff; padding: 20px; overflow-y: auto; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        #grid-container h3 { margin-top: 0; margin-bottom: 15px; font-size: 1.1em; font-weight: 600; color: #3c4043; }
        .data-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 6px; }
        .grid-cell { width: 100%; padding-bottom: 100%; background-color: #eceff1; border-radius: 4px; position: relative; transition: background-color 0.3s; }
        .grid-cell span { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: rgba(0,0,0,0.4); font-size: 0.75em; }
    </style>
</head>
<body>
    <div class="top-bar"><h1>Smart Farm Dashboard</h1></div>
    <div class="main-container">
        <nav class="side-bar">
            <h2>‡∏™‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
            <ul id="garden-list">
                <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ß‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ JavaScript -->
            </ul>
        </nav>
        <main class="content-area">
            <div id="map-container"><div id="map"></div></div>
            <div id="grid-container">
                <h3 id="grid-title">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ß‡∏ô</h3>
                <div class="data-grid" id="data-grid"></div>
            </div>
        </main>
    </div>

<script>
    let map;
    let activeGardenId = null;
    const polygons = {};
    const infoWindows = {};
    const gardenColors = ["#FFC107", "#2196F3", "#4CAF50", "#E91E63", "#9C27B0", "#00BCD4"];

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ß‡∏ô‡πÉ‡∏ô Sidebar
    function addGardenToSidebar(garden) {
        const list = document.getElementById('garden-list');
        const listItem = document.createElement('li');
        listItem.id = `garden-item-${garden.garden_id}`;
        listItem.onclick = () => setActiveGarden(garden.garden_id);
        
        const nameSpan = document.createElement('span');
        nameSpan.innerText = `‡∏™‡∏ß‡∏ô‡∏ó‡∏µ‡πà ${garden.garden_id}`;
        
        const deleteBtn = document.createElement('span');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = 'üóëÔ∏è';
        deleteBtn.onclick = (e) => {
            e.stopPropagation();
            deleteGarden(garden.garden_id);
        };
        
        listItem.appendChild(nameSpan);
        listItem.appendChild(deleteBtn);
        list.appendChild(listItem);
    }

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏≠‡∏¢‡∏π‡πà
    function setActiveGarden(gardenId) {
        if (activeGardenId) {
            document.getElementById(`garden-item-${activeGardenId}`)?.classList.remove('active');
        }
        document.getElementById(`garden-item-${gardenId}`)?.classList.add('active');
        document.getElementById('grid-title').innerText = `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏µ ‡∏™‡∏ß‡∏ô‡∏ó‡∏µ‡πà ${gardenId} (100 ‡πÅ‡∏õ‡∏•‡∏á‡∏¢‡πà‡∏≠‡∏¢)`;
        activeGardenId = gardenId;
        createGridCells();
    }
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏£‡∏¥‡∏î
    function createGridCells() {
        const grid = document.getElementById('data-grid');
        grid.innerHTML = '';
        if (!activeGardenId) return;
        for (let i = 0; i < 100; i++) {
            const cell = document.createElement('div');
            cell.className = 'grid-cell';
            cell.id = `g${activeGardenId}-cell-${i}`;
            const cellNumber = document.createElement('span');
            cellNumber.innerText = i + 1;
            cell.appendChild(cellNumber);
            grid.appendChild(cell);
        }
    }

    // ‡∏ß‡∏≤‡∏î Polygon ‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
    function createPolygon(garden) {
        const gardenId = garden.garden_id;
        if (polygons[gardenId]) polygons[gardenId].setMap(null);

        const color = gardenColors[(gardenId - 1) % gardenColors.length];
        const polygon = new google.maps.Polygon({
            paths: garden.coords,
            strokeColor: color, strokeOpacity: 0.9, strokeWeight: 2,
            fillColor: color, fillOpacity: 0.35,
            map: map
        });

        const infoWindow = new google.maps.InfoWindow({
            content: `<b>‡∏™‡∏ß‡∏ô‡∏ó‡∏µ‡πà ${gardenId}</b>  
‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(garden.created_at).toLocaleString()}`
        });

        const label = new google.maps.Marker({
            position: getCenterOfPolygon(polygon),
            map: map,
            label: { text: `‡∏™‡∏ß‡∏ô ${gardenId}`, color: "white", fontSize: "14px", fontWeight: "bold" },
            icon: { path: google.maps.SymbolPath.CIRCLE, scale: 0 }
        });
        
        polygon.addListener('click', (e) => infoWindow.open(map, { lat: e.latLng.lat(), lng: e.latLng.lng() }));
        
        polygons[gardenId] = { polygon, label, infoWindow };
    }

    // ‡∏•‡∏ö Polygon ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å UI
    function removeGardenFromUI(gardenId) {
        document.getElementById(`garden-item-${gardenId}`)?.remove();
        if (polygons[gardenId]) {
            polygons[gardenId].polygon.setMap(null);
            polygons[gardenId].label.setMap(null);
            delete polygons[gardenId];
        }
        if (activeGardenId == gardenId) {
            activeGardenId = null;
            document.getElementById('grid-title').innerText = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ß‡∏ô';
            document.getElementById('data-grid').innerHTML = '';
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏≤‡∏à‡∏∏‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡∏≠‡∏á Polygon
    function getCenterOfPolygon(polygon) {
        const bounds = new google.maps.LatLngBounds();
        polygon.getPath().getArray().forEach(v => bounds.extend(v));
        return bounds.getCenter();
    }

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
    async function fetchAllGardens() {
        try {
            const response = await fetch('/api/get_all_gardens');
            const gardens = await response.json();
            console.log('[Init] ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:', gardens);
            gardens.forEach(garden => {
                addGardenToSidebar(garden);
                createPolygon(garden);
            });
            if (gardens.length > 0) {
                setActiveGarden(gardens[0].garden_id);
            }
        } catch (error) {
            console.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ß‡∏ô‡πÑ‡∏î‡πâ:', error);
        }
    }
    
    // ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏ö‡∏™‡∏ß‡∏ô
    async function deleteGarden(gardenId) {
        if (confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö "‡∏™‡∏ß‡∏ô‡∏ó‡∏µ‡πà ${gardenId}"?\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏≤‡∏ß‡∏£`)) {
            try {
                const response = await fetch(`/api/delete_garden/${gardenId}`, { method: 'DELETE' });
                if (!response.ok) {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏ß‡∏ô');
                }
            } catch (error) {
                console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö:', error);
            }
        }
    }

    // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WebSocket
    function connectWebSocket() {
        const ws = new WebSocket(`ws://${window.location.host}`);
        ws.onopen = () => console.log("[WebSocket] ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        ws.onmessage = (event) => {
            const message = JSON.parse(event.data);
            console.log("[WebSocket] ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á:", message);

            switch (message.type) {
                case 'new_garden_added':
                    addGardenToSidebar(message.data);
                    createPolygon(message.data);
                    if (!activeGardenId) setActiveGarden(message.data.garden_id);
                    break;
                case 'garden_deleted':
                    removeGardenFromUI(message.data.garden_id);
                    break;
            }
        };
        ws.onclose = () => {
            console.log("[WebSocket] ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡∏î‡∏Ç‡∏≤‡∏î! ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ...");
            setTimeout(connectWebSocket, 3000);
        };
    }

    // ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 14.039, lng: 100.613 }, zoom: 16, mapTypeId: 'satellite'
        });
        fetchAllGardens();
        connectWebSocket();
    }
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAnohODDdNYfmogkNb-LUPPFNn79ZwP-YQ&callback=initMap"></script>
</body>
</html>
